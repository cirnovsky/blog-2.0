---
date: '2023-11-07'
title: 'Solution -ã€ŒYali Camp 2018ã€è´ªç©è“æœˆ'
---

æˆ‘è¯´æ€ä¹ˆ T2 è¢«æš´åˆ‡ï¼ŒåŸæ¥å¤§å®¶éƒ½åšè¿‡è¿™é“é¢˜ï¼Œè¿™ä¸‹æ˜¯ ğŸ¤¡ äº†ã€‚

## Desc.

[Link.](https://loj.ac/p/6515)

æœ‰ $m$ æ¬¡äº‹ä»¶ï¼Œå’Œä¸€ä¸ªåˆå§‹ä¸ºç©ºçš„åŒç«¯é˜Ÿåˆ—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

- `IF w v`ï¼š$\text{PUSH-FRONT}(w, v)$ï¼›
- `IG w v`ï¼š$\text{PUSH-BACK}(w, v)$ï¼›
- `DF`ï¼š$\text{POP-FRONT}$ï¼›
- `DG`ï¼š$\text{POP-BACK}$ï¼›
- `QU l r`ï¼šè¯¢é—®åœ¨å½“å‰é˜Ÿåˆ—ä¸­é€‰å–è‹¥å¹²äºŒå…ƒç»„ $S$ï¼Œä½¿å¾— $\sum w \in S \bmod p \in [l, r]$ï¼Œä¸” $\sum v \in S$ æœ€å¤§ã€‚

$m \leqslant 5 \times 10^4$ï¼Œ$p \leqslant 500$ã€‚

## Sol.

æœ´ç´  DP å¾ˆå®¹æ˜“ï¼Œè®¾ $f_{i, s}$ è¡¨ç¤ºå‰ $i$ ä¸ªå…ƒç´ ä¸­ï¼Œ$w$ å’Œæ¨¡ $p$ çš„ä½™æ•°ä¸º $s$ çš„æœ€å¤§ $v$ å’Œã€‚å…³é”®æ˜¯å¦‚ä½•ç»´æŠ¤åŒç«¯é˜Ÿåˆ—çš„æ“ä½œã€‚

å¦‚æœç»´æŠ¤çš„æ•°æ®ç»“æ„æ˜¯æ ˆï¼Œé‚£ä¹ˆè¿™ä¸ªé¢˜å°±å˜å¾—å¾ˆå®¹æ˜“äº†ï¼Œæ°å¥½ï¼Œæˆ‘ä»¬æœ‰ç”¨æ ˆå®ç°åŒç«¯é˜Ÿåˆ—çš„æ–¹æ³•ï¼Œä»¥ä¸‹æ˜¯ tly çš„è§£è¯´ï¼š

>è‡³å°‘æ”¯æŒï¼šåŒç«¯æ’å…¥åˆ é™¤ï¼ˆåˆ é™¤æ—¶éç©ºï¼‰ï¼Œç»´æŠ¤åŠç¾¤è¿ç®—ï¼ˆåªæœ‰ç»“åˆå¾‹ï¼‰ï¼Œåšåˆ°å‡æ‘Š $\mathcal O(n)$ æ¬¡è¿ç®—ã€‚
>
>æ¯”å¦‚åŒç«¯æ’å…¥åˆ é™¤å…ƒç´ ï¼Œæ±‚çŸ©é˜µä¹˜æˆ–è€… min ä¹‹ç±»çš„ä¸å¯å‡ä¿¡æ¯ã€‚
>
>â€¦â€¦
>
>å…·ä½“åšæ³•æ˜¯ç»´æŠ¤ä¸¤ä¸ªæ ˆï¼Œåˆ†åˆ«ç”¨äºå‰ç«¯æ’å…¥åˆ é™¤/åç«¯æ’å…¥åˆ é™¤ã€‚è¿™ä¸ªæ—¶å€™å°±æ˜¯ã€Œæ’å…¥åŒç«¯åˆ é™¤ï¼Œä¹Ÿå³å¯æ’¤å›ã€çš„æƒ…å†µäº†ã€‚
>
>å¦‚æœä¸€ä¸ªæ ˆç©ºäº†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸èƒ½ç›´æ¥æŠŠå¦ä¸€ä¸ªæ ˆå¼„è¿‡æ¥ã€‚
>
>è€ƒè™‘å°†å¦ä¸€ä¸ªæ ˆçš„å…ƒç´ æŒ‰ä¸­ç‚¹åˆ’åˆ†å¼€ï¼Œåˆ†åˆ«è£…å…¥ä¸¤ä¸ªæ ˆï¼Œè¿™æ ·å¤æ‚åº¦æ˜¯å‡æ‘Š $\mathcal O(n)$ã€‚
>39
>å…·ä½“åŸå› è€ƒè™‘åŠ¿èƒ½å‡½æ•° $\Phi = |size_1 - size_2|$ï¼Œæ¯æ¬¡ $\Phi$ è‡³å¤šå¢åŠ  $1$ï¼Œé‡æ„åˆ™æ¸…é›¶ï¼ˆæˆ–å˜æˆ $1$ï¼‰ï¼Œå› æ­¤å¤æ‚åº¦å‡æ‘Šä¸‹æ¥çº¿æ€§ã€‚
>
>ï¼ˆæœ‰åˆ æ”¹ï¼‰

ä»£ç å¾ˆç®€æ´ã€‚

```cpp
int __tmp, m, p, w[2][50100], v[2][50100], top[2], q[600];
ll dp[2][50100][600];
string op;
void insert(int a, int b, int f) {
    w[f][++top[f]] = a, v[f][top[f]] = b;
    for (int i=0;i<p;++i)
        dp[f][top[f]][(i+a)%p] = max(dp[f][top[f]-1][i]+b, dp[f][top[f]-1][(i+a)%p]);
}
void remove(int f) {
    if (top[f] == 0) {
        int tmp = top[f^1];
        top[0] = top[1] = 0;
        for (int i=(tmp+1)/2;i>=1;--i) insert(w[f^1][i], v[f^1][i], f);
        for (int i=(tmp+1)/2+1;i<=tmp;++i) insert(w[f^1][i], v[f^1][i], f^1);
    }
    top[f]--;
}
ll ask(int l, int r) {
    ll res = -1, *f = dp[0][top[0]], *g = dp[1][top[1]];
    int h = 1, t = 0;
    for (int i=r;i>=l;--i) {
        while (h <= t && g[i] >= g[q[t]]) t--;
        q[++t] = i;
    }
    for (int i=0;i<p;++i) {
        while (h <= t && ((i+q[h])%p < l || (i+q[h])%p > r)) h++;
        while (h <= t && g[(l+p-i)%p] >= g[q[t]]) t--;
        q[++t] = (l+p-i)%p;
        cmax(res, f[i]+g[q[h]]);
    }
    return res;
}
int main() {
    ios::sync_with_stdio(0);
    cin.tie(nullptr);
    for (int i=0;i<2;++i)
        memset(dp[i][0]+1, 0xcf, sizeof dp[i][0]);
    cin >> __tmp >> m >> p;
    for (int a, b; m--;) {
        cin >> op;
        if (op[0] == 'I' || op[0] == 'Q') cin >> a >> b;
        if (op == "IF") insert(a%p, b, 0);
        else if (op == "IG") insert(a%p, b, 1);
        else if (op == "DF") remove(0);
        else if (op == "DG") remove(1);
        else cout << ask(a, b) << "\n";
    }
}
```

---

> æˆ‘æ—¢æ²¡æœ‰æ„è‹¦åˆ°è¶³ä»¥æˆä¸ºè¯—äººï¼Œåˆæ²¡æœ‰å†·æ¼ åˆ°åƒä¸ªå“²å­¦å®¶ã€‚ä½†æˆ‘æ¸…é†’åˆ°è¶³ä»¥æˆä¸ºä¸€ä¸ªåºŸäººã€‚
>
> [â€”â€” EÂ·MÂ·é½å¥¥æœ— - *çœ¼æ³ªä¸åœ£å¾’*](https://book.douban.com/subject/25774978/)
